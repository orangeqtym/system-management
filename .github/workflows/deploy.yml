name: Deploy Application

on:
  repository_dispatch:
    types: [deploy-app]

jobs:
  deploy:
    runs-on: self-hosted # This must run on your local machine
    steps:
      - name: Checkout system-management repository
        uses: actions/checkout@v3

      - name: Parse Dispatch Payload
        id: payload
        run: |
          echo "service=${{ github.event.client_payload.service }}" >> $GITHUB_OUTPUT
          echo "tag=${{ github.event.client_payload.tag }}" >> $GITHUB_OUTPUT
          echo "environment=${{ github.event.client_payload.environment }}" >> $GITHUB_OUTPUT

      - name: Log in to the Container registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Execute Deployment Script
        run: |
          SERVICE="${{ steps.payload.outputs.service }}"
          ENVIRONMENT="${{ steps.payload.outputs.environment }}"
          TAG="${{ steps.payload.outputs.tag }}"

          case "$SERVICE" in
            "email-service")
              bash scripts/deploy.sh "$ENVIRONMENT" "$SERVICE" "$TAG"
              ;;
            "meal-planner-api")
              bash scripts/deploy.sh "$ENVIRONMENT" "$SERVICE" "$TAG"
              ;;
            *)
              echo "Unknown service: $SERVICE"
              exit 1
              ;;
          esac

          # Deploy new services
          cd "${ENVIRONMENT}" && docker compose up -d database
          cd "${ENVIRONMENT}" && docker compose up -d api-service
          cd "${ENVIRONMENT}" && docker compose up -d webapp
